namespace MailScanner.Shared;

public class MailService
{
    public readonly MailScannerContext _context;
    public readonly ILogger _logger;
    public readonly IConfiguration _configuration;
    public MailService(MailScannerContext context, ILogger logger, IConfiguration configuration)
    {
        _context = context;
        _logger = logger;
        _configuration = configuration;
    }

    public void Run()
    {

        using var client = new ImapClient();
        client.Connect(_configuration["IMAP_HOST"], 993, true);

        client.Authenticate(_configuration["IMAP_USER"], _configuration["IMAP_PASSWORD"]);

        //open archive folder

        var inboxFolder = client.Inbox;
        inboxFolder.Open(FolderAccess.ReadWrite);

        SearchQuery search = SearchQuery.SubjectContains("qwerqtewrtqwdsagsdga  q");
        if (!_context.Keywords.Any())
        {
            var keyword = new Keyword
            {
                Value = "Kasticket"
            };
            _context.Keywords.Add(keyword);
            _context.SaveChanges();
        }
        foreach (var keyword in _context.Keywords)
        {
            search = search.Or(SearchQuery.SubjectContains(keyword.Value).Or(SearchQuery.BodyContains(keyword.Value)));
        }

        var uids = inboxFolder.Search(search);

        foreach (var uid in uids)
        {
            var message = inboxFolder.GetMessage(uid);
            var invoice = new Invoice
            {
                Date = message.Date.Date,
                Subject = message.Subject,
                Body = message.TextBody,
                Sender = message.From.ToString(),
                Receiver = message.To.ToString(),

            };
            if (message.Attachments.Any())
            {
                foreach (var attachment in message.Attachments)
                {
                    if (_configuration["FILE_LOCATION"] is null)
                    {
                        _logger.Information("FILE_LOCATION not set, add it to the environment variables please.");
                        return;
                    }
                    using var stream = File.Create($"{_configuration["FILE_LOCATION"]}{attachment.ContentDisposition?.FileName}");
                    if (attachment is MessagePart)
                    {
                        var part = (MessagePart)attachment;

                        part.Message.WriteTo(stream);
                    }
                    else
                    {
                        var part = (MimePart)attachment;

                        part.Content.DecodeTo(stream);
                    }
                }
                //flag the message as processed
                client.Inbox.AddFlags(uid, MessageFlags.UserDefined, true);
            }
        }
    }
}